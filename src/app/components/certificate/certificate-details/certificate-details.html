<p-toast position="top-center"></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- Download Keystore Dialog -->
<p-dialog [(visible)]="showDownloadDialog" header="Download Keystore" modal="true" styleClass="p-fluid"
    [style]="{width: '450px'}">

    <form [formGroup]="downloadForm" (ngSubmit)="downloadKeystore()">
        <div class="grid">
            <div class="col-12">
                <label for="keystoreType" class="block font-medium mb-2">Keystore Type</label>
                <p-select id="keystoreType" formControlName="keystoreType" [options]="keystoreTypes" optionLabel="label"
                    optionValue="value" styleClass="w-full">
                </p-select>
            </div>

            <div class="col-12">
                <label for="keystorePassword" class="block font-medium mb-2">Keystore Password</label>
                <p-password id="keystorePassword" formControlName="keystorePassword"
                    placeholder="Enter keystore password" styleClass="w-full" inputStyleClass="w-full"
                    [feedback]="false" [toggleMask]="true">
                </p-password>
            </div>

            <div class="col-12">
                <label for="alias" class="block font-medium mb-2">Certificate Alias</label>
                <input pInputText id="alias" formControlName="alias" placeholder="certificate" styleClass="w-full" />
            </div>
        </div>

        <div >
            <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="showDownloadDialog = false">
            </p-button>
            <p-button type="submit" label="Download" icon="pi pi-download" [loading]="downloadLoading"
                [disabled]="downloadForm.invalid">
            </p-button>
        </div>
    </form>
</p-dialog>

<!-- Revocation Dialog -->
<p-dialog [(visible)]="showRevocationDialog" header="Revoke Certificate" modal="true" styleClass="p-fluid"
    [style]="{width: '450px'}">

    <form [formGroup]="revocationForm" (ngSubmit)="revokeCertificate()">
        <div class="mb-4">
            <p>Are you sure you want to revoke this certificate?</p>
            <p><strong>{{certificate?.subjectDN}}</strong></p>
        </div>

        <div class="grid">
            <div class="col-12">
                <label for="revocationReason" class="block font-medium mb-2">Revocation Reason</label>
                <p-select id="revocationReason" formControlName="revocationReason" [options]="revocationReasons"
                    optionLabel="label" optionValue="value" styleClass="w-full">
                </p-select>
            </div>

            <div class="col-12">
                <label for="reasonText" class="block font-medium mb-2">Additional Information (Optional)</label>
                <textarea pInputText id="reasonText" formControlName="reasonText" rows="3"
                    placeholder="Provide additional details..." styleClass="w-full">
            </textarea>
            </div>
        </div>

        <div>
            <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="showRevocationDialog = false">
            </p-button>
            <p-button type="submit" label="Revoke" icon="pi pi-ban" severity="danger" [loading]="revocationLoading"
                [disabled]="revocationForm.invalid">
            </p-button>
        </div>
    </form>
</p-dialog>

<div class="grid">
    <div class="col-12">
        <p-card>
            <ng-template pTemplate="header">
                <div class="p-4 border-bottom-1 surface-border">
                    <div class="flex justify-content-between align-items-start">
                        <div>
                            <h2 class="m-0 mb-2">Certificate Details</h2>
                            <p class="m-0 text-color-secondary" *ngIf="!loading">
                                {{certificate?.subjectDN}}
                            </p>
                        </div>
                        <div class="flex gap-2" *ngIf="!loading && certificate">
                            <p-tag [value]="certificate.certificateType"
                                [severity]="getCertTypeSeverity(certificate.certificateType)">
                            </p-tag>
                            <p-tag [value]="certificate.revoked ? 'Revoked' : 'Active'"
                                [severity]="certificate.revoked ? 'danger' : 'success'">
                            </p-tag>
                        </div>
                    </div>
                </div>
            </ng-template>

            <div class="p-4" *ngIf="loading">
                <div class="grid">
                    <div class="col-12 md:col-6">
                        <p-skeleton height="2rem" class="mb-3"></p-skeleton>
                        <p-skeleton height="1.5rem" class="mb-2"></p-skeleton>
                        <p-skeleton height="1.5rem" class="mb-2"></p-skeleton>
                    </div>
                    <div class="col-12 md:col-6">
                        <p-skeleton height="2rem" class="mb-3"></p-skeleton>
                        <p-skeleton height="1.5rem" class="mb-2"></p-skeleton>
                        <p-skeleton height="1.5rem" class="mb-2"></p-skeleton>
                    </div>
                </div>
            </div>

            <div class="p-4" *ngIf="!loading && certificate">
                <p-tabs value="0">
                    <p-tablist>
                        <p-tab value="0">General</p-tab>
                        <p-tab value="1">Subject & Issuer</p-tab>
                        <p-tab value="2">Certificate Data</p-tab>
                    </p-tablist>
                    <!-- General Information Tab -->
                    <p-tabpanel header="General" value="0" leftIcon="pi pi-info-circle">
                        <div class="grid">
                            <div class="col-12 lg:col-6">
                                <p-fieldset legend="Certificate Information" [toggleable]="true">
                                    <div class="field-row">
                                        <strong>Serial Number:</strong>
                                        <code class="ml-2">{{certificate.serialNumber}}</code>
                                    </div>

                                    <div class="field-row">
                                        <strong>Type:</strong>
                                        <span class="ml-2">{{formatCertificateType(certificate.certificateType)}}</span>
                                    </div>

                                    <div class="field-row">
                                        <strong>Status:</strong>
                                        <p-tag class="ml-2" [value]="certificate.revoked ? 'Revoked' : 'Active'"
                                            [severity]="certificate.revoked ? 'danger' : 'success'">
                                        </p-tag>
                                    </div>

                                    <div class="field-row" *ngIf="certificate.revoked">
                                        <strong>Revocation Date:</strong>
                                        <span class="ml-2">{{certificate.revocationDate | date:'medium'}}</span>
                                    </div>

                                    <div class="field-row" *ngIf="certificate.revoked && certificate.revocationReason">
                                        <strong>Revocation Reason:</strong>
                                        <span
                                            class="ml-2">{{formatRevocationReason(certificate.revocationReason)}}</span>
                                    </div>

                                    <div class="field-row">
                                        <strong>Has Private Key:</strong>
                                        <span class="ml-2">
                                            <i class="pi"
                                                [class]="certificate.hasPrivateKey ? 'pi-check text-green-500' : 'pi-times text-red-500'"></i>
                                            {{certificate.hasPrivateKey ? 'Yes' : 'No'}}
                                        </span>
                                    </div>
                                </p-fieldset>
                            </div>

                            <div class="col-12 lg:col-6">
                                <p-fieldset legend="Validity" [toggleable]="true">
                                    <div class="field-row">
                                        <strong>Valid From:</strong>
                                        <span class="ml-2">{{certificate.validFrom | date:'medium'}}</span>
                                    </div>

                                    <div class="field-row">
                                        <strong>Valid To:</strong>
                                        <span class="ml-2"
                                            [class]="isExpiringSoon(certificate.validTo) ? 'text-orange-500' : ''">
                                            {{certificate.validTo | date:'medium'}}
                                            <i *ngIf="isExpiringSoon(certificate.validTo)"
                                                class="pi pi-exclamation-triangle ml-2 text-orange-500"></i>
                                        </span>
                                    </div>

                                    <div class="field-row">
                                        <strong>Days Until Expiry:</strong>
                                        <span class="ml-2"
                                            [class]="getDaysUntilExpiry() <= 30 ? 'text-orange-500' : ''">
                                            {{getDaysUntilExpiry()}} days
                                        </span>
                                    </div>
                                </p-fieldset>

                                <p-fieldset legend="Actions" [toggleable]="true" class="mt-3">
                                    <div class="flex flex-column gap-2">
                                        <p-button label="Download Certificate" icon="pi pi-download" size="small"
                                            severity="secondary" (onClick)="downloadCertificateOnly()">
                                        </p-button>

                                        <p-button *ngIf="certificate.hasPrivateKey" label="Download with Private Key"
                                            icon="pi pi-key" size="small" (onClick)="showDownloadDialog = true">
                                        </p-button>

                                        <p-button *ngIf="!certificate.revoked && canRevoke()" label="Revoke Certificate"
                                            icon="pi pi-ban" size="small" severity="danger"
                                            (onClick)="showRevocationDialog = true">
                                        </p-button>
                                    </div>
                                </p-fieldset>
                            </div>
                        </div>
                    </p-tabpanel>

                    <!-- Subject & Issuer Tab -->
                    <p-tabpanel header="Subject & Issuer" value="1" leftIcon="pi pi-users">
                        <div class="grid">
                            <div class="col-12 lg:col-6">
                                <p-fieldset legend="Subject Distinguished Name" [toggleable]="true">
                                    <div class="field-content">
                                        <code class="break-word">{{certificate.subjectDN}}</code>
                                    </div>
                                    <div class="mt-3">
                                        <h6>Parsed Subject Components:</h6>
                                        <div class="subject-components">
                                            <div *ngFor="let component of parseDistinguishedName(certificate.subjectDN)"
                                                class="component-item">
                                                <strong>{{component.name}}:</strong> {{component.value}}
                                            </div>
                                        </div>
                                    </div>
                                </p-fieldset>
                            </div>

                            <div class="col-12 lg:col-6">
                                <p-fieldset legend="Issuer Distinguished Name" [toggleable]="true">
                                    <div class="field-content">
                                        <code class="break-word">{{certificate.issuerDN}}</code>
                                    </div>
                                    <div class="mt-3">
                                        <h6>Parsed Issuer Components:</h6>
                                        <div class="subject-components">
                                            <div *ngFor="let component of parseDistinguishedName(certificate.issuerDN)"
                                                class="component-item">
                                                <strong>{{component.name}}:</strong> {{component.value}}
                                            </div>
                                        </div>
                                    </div>
                                </p-fieldset>
                            </div>
                        </div>
                    </p-tabpanel>

                    <!-- Certificate Data Tab -->
                    <p-tabpanel header="Certificate Data" value="2" leftIcon="pi pi-file">
                        <div class="grid">
                            <div class="col-12">
                                <p-fieldset legend="PEM Encoded Certificate" [toggleable]="true" [collapsed]="true">
                                    <div class="certificate-data">
                                        <textarea readonly [value]="certificate.certificateData" rows="20"
                                            class="w-full font-mono text-sm border-round">
                        </textarea>
                                    </div>
                                    <div class="mt-2">
                                        <p-button label="Copy to Clipboard" icon="pi pi-copy" size="small" [text]="true"
                                            (onClick)="copyToClipboard(certificate.certificateData)">
                                        </p-button>
                                    </div>
                                </p-fieldset>
                            </div>
                        </div>
                    </p-tabpanel>
                </p-tabs>
            </div>

            <ng-template pTemplate="footer">
                <div class="flex justify-content-between">
                    <p-button label="Back to Certificates" icon="pi pi-arrow-left" severity="secondary" [text]="true"
                        (onClick)="goBack()">
                    </p-button>

                    <p-button label="Refresh" icon="pi pi-refresh" [text]="true" [loading]="loading"
                        (onClick)="loadCertificate()">
                    </p-button>
                </div>
            </ng-template>
        </p-card>
    </div>
</div>